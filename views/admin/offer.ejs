<!DOCTYPE html>
<html lang="en">
  <!-- Mirrored from wp.alithemes.com/html/evara/evara-backend/page-categories.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 01 Aug 2021 15:33:21 GMT -->
  <head>
    <meta charset="utf-8" />
    <title>Offer Management</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta property="og:title" content="" />
    <meta property="og:type" content="" />
    <meta property="og:url" content="" />
    <meta property="og:image" content="" />
    <!-- Favicon -->


    <!-- Include Toastify CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css">


    <style>
      #btnBlock {
          color: #fff;
          background-color: #ff7700;
          border: 1px solid #ff7700;
          padding: 5px 10px;
          border-radius: 4px;
      }
      
      #btnUnblock {
          color: #fff;
          background-color: #28a745;
          border: 1px solid #28a745;
          padding: 5px 10px;
          border-radius: 4px;
      }
  </style>
    <link
      rel="shortcut icon" type="image/x-icon" href="/user-assets/images/icons/FAVICON SW.png"/>
    <!-- Template CSS -->
    <link href="admin-assets/css/main.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
  </head>

  <body>
    <div class="screen-overlay"></div>
    <%- include('./partials/adminAside.ejs') %>
    <main class="main-wrap">
      <%- include('./partials/adminNav.ejs') %>
      <section class="content-main">
        <div class="content-header">
          <div>
            <h2 class="content-title card-title">Offer</h2>
            <p>Add, edit or delete a Offer</p>
          </div>
          <div>
            <input
              type="text"
              placeholder="Search Categories"
              class="form-control bg-white"
            />
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <!-- Coupon -->
      
                <form id="addOffer">
                    <div class="container">
                      <!-- Coupon Name -->
                      <div class="mb-4">
                        <label for="couponName" class="form-label">Offer Name</label>
                        <input
                          type="text"
                          placeholder="Enter the coupon name"
                          name="offerName"
                          class="form-control"
                          id="offer_name"
                        />
                      </div>
                  
                      
                  
                      
                      <!-- Discount -->
                      <div class="mb-4">
                        <label for="discount" class="form-label">Discount In Percentage</label>
                        <input
                          type="text"
                          placeholder="Enter discount value"
                          name="discountInPercentage"
                          class="form-control"
                          id="discount_percentage"
                        />
                      </div>
                  
                      
                      
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="d-grid">
                      <button type="submit" class="btn btn-primary">Add Offer</button>
                    </div>
                  </form>
                  
                
      
                <!-- ------------------------ -->
              </div>
              <div class="col-md-9">
                <div class="table-responsive">
                <% if (offer&&offer.length>0 ) { %>
                 
             
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th class="text-center">
                            <h6>No.</h6>
                          </th>
                          <th>Offer Name</th>
                          <th>Percentage</th>
                          <th>Status</th>
                          <th class="text-center" style="text-align: center;">Action</th>

                        </tr>
                      </thead>
                      <tbody>
                        <% for( let i = 0; i < offer.length; i++ ) { %>
                        
                        
                          <tr>
                            <td class="text-center">
                              <%= i + 1 %>
                            </td>
                            <td>
                            <%= offer[i].offerName %>
                            </td>


                            <td>
                              <%= offer[i].offerPercentage %>%
                            </td>


                            <td>
                              <% if (offer[i].isActive) { %>
                               
                             
                             <!-- Ensure field name consistency -->
                                <span class="badge rounded-pill alert-success">Active</span>
                            <% } else { %>
                             
                                <span class="badge rounded-pill alert-danger">Inactive</span>
                                <% } %>
                            </td>
                            <td class="text-end">
                              <div>
                                <!-- Edit Button -->
                                <a href="/admin/editOffer?id=<%= offer[i]._id %>" class="btn bg-dark text-white rounded btn-sm">Edit</a>
                              
                                <!-- Block/Unblock Button
                                <% if (offer[i].isActive) { %>
                                  <a href="#" data-offer-id="<%= offer[i]._id %>" class="btn btn-warning btn-sm block-unblock">Block</a>
                                <% } else { %>
                                  <a href="#" data-offer-id="<%= offer[i]._id %>" class="btn btn-success btn-sm block-unblock">Unblock</a>
                                <% } %>
                               -->
                                <!-- Delete Button -->
                                <a href="#" data-offer-id="<%= offer[i]._id %>" class="btn btn-danger btn-sm delete-offer">Delete</a>
                              </div>
                              
                              
                            </td>
                          </tr>
                          <% } %>
                      </tbody>
                    </table>
                                                                                      
                   
                    <% } %>
                </div>
              </div>
                                                                                       
            </div>
            <!-- .row // -->
          </div>
          <!-- card body .// -->
        </div>
        <!-- card .// -->
      </section>
      
      <!-- content-main end// -->
    </main>
    <script src="admin-assets/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="admin-assets/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="admin-assets/js/vendors/select2.min.js"></script>
    <script src="admin-assets/js/vendors/perfect-scrollbar.js"></script>
    <script src="admin-assets/js/vendors/jquery.fullscreen.min.js"></script>
    <!-- Main Script -->
    <script src="admin-assets/js/main.js" type="text/javascript"></script>

    <!-- Include Toastify JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!--Action  button -->

    <script>
        
        document.addEventListener('DOMContentLoaded', function() {
    let buttons = document.querySelectorAll(".block-unblock");

    for (let i = 0; i < buttons.length; i++) {
      buttons[i].addEventListener("click", async function (event) {
        event.preventDefault(); 

        let button = buttons[i];
        let offerId = button.getAttribute("data-offer-id"); 
        let action = button.textContent.trim().toLowerCase(); 

        let url = action === "block" ? `/admin/blockOffer?id=${offerId}` : `/admin/unblockOffer?id=${offerId}`;
        
        try {
         
          let response = await fetch(url, { method: 'GET' });
          let result = await response.json();

          if (result.success) {
            
            Swal.fire({
              title: action === "block" ? "Offer Blocked!" : "Offer Unblocked!",
              text: action === "block" ? "The offer has been successfully blocked." : "The offer has been successfully unblocked.",
              icon: "success",
              confirmButtonText: "OK"
            }).then(() => {
              
              window.location.reload();
            });

          } else {
            
            Swal.fire({
              title: "Error!",
              text: "There was an error updating the offer status.",
              icon: "error",
              confirmButtonText: "OK"
            });
          }
        } catch (error) {
          console.error("Error:", error);

         
          Swal.fire({
            title: "Error!",
            text: "There was a problem processing the request.",
            icon: "error",
            confirmButtonText: "OK"
          });
        }
      });
    }
  });

  document.addEventListener('DOMContentLoaded', function() {
  let deleteButtons = document.querySelectorAll(".delete-offer");

  for (let i = 0; i < deleteButtons.length; i++) {
    deleteButtons[i].addEventListener("click", async function(event) {
      event.preventDefault(); // Prevent default link behavior

      let button = deleteButtons[i];
      let offerId = button.getAttribute("data-offer-id"); // Get the offer ID

      // SweetAlert confirmation dialog
      const { isConfirmed } = await Swal.fire({
        title: 'Are you sure?',
        text: "This action cannot be undone.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'No, cancel!',
      });

      if (isConfirmed) {
        try {
          // Send DELETE request to the server
          let response = await fetch(`/admin/deleteOffer?id=${offerId}`, { method: 'DELETE' });
          let result = await response.json();

          if (result.success) {
            // Optionally, remove the offer row from the UI
            button.closest("tr").remove(); // Assuming the button is in a table row
            Swal.fire(
              'Deleted!',
              'Offer deleted successfully.',
              'success'
            );
          } else {
            console.error("Error deleting offer:", result.message);
            Swal.fire(
              'Error!',
              result.message || 'There was an error deleting the offer.',
              'error'
            );
          }
        } catch (error) {
          console.error("Error:", error);
          Swal.fire(
            'Error!',
            'There was an error processing your request.',
            'error'
          );
        }
      }
    });
  }
});

    </script>




<script>
  async function addOffer(event) {
    event.preventDefault();

    let offerName = document.getElementById('offer_name').value;
    let offerPercentage = document.getElementById('discount_percentage').value;
    let parsedOffer = parseInt(offerPercentage);

    let offerData = {
      offerName: offerName,
      offerPercentage: parsedOffer,
    };

    try {
      const response = await fetch('/admin/addOffer', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(offerData),
      });

      const data = await response.json();

      if (data.success) {
        // Success message from controller
        Toastify({
          text: data.message || "Offer updated successfully!",
          duration: 3000,
          gravity: "top", 
          position: "right",
          backgroundColor: "green",
          close: true,
        }).showToast();


        setTimeout(() => {
          window.location.reload();
        }, 3000);
      } else {
        // Error message from controller
        const errorMessage = data.errors && data.errors.length > 0
          ? data.errors.join(', ') // Show all errors
          : data.message || "Error updating offer";

        Toastify({
          text: errorMessage,
          duration: 3000,
          gravity: "top",
          position: "right",
          backgroundColor: "red",
          close: true,
        }).showToast();
      }
    } catch (error) {
      console.error('Error:', error);

      // Display generic error message for exceptions
      Toastify({
        text: "An error occurred. Please try again.",
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: "red",
        close: true,
      }).showToast();
    }
  }

  document.getElementById("addOffer").addEventListener('submit', addOffer);
</script>










  
  </body>
</html>
